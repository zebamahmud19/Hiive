WITH RAW AS
(
SELECT DISTINCT
OPEN_DATE, 
TO_CHAR(INSERTED_AT, 'MM') AS OPEN_MONTH,
ID,
DATEDIFF(HOUR,INSERTED_AT,CURRENT_DATE)/24 AS OPEN_TIME
FROM ANALYTICS_DEV.PAYMENT_GATEWAY.VW_TNX
WHERE 1 = 1
AND TRANSACTION_TYPE NOT IN ('INACTIVE')
AND TERMINATION_REASON IS NULL
GROUP BY 1,2,3,4
)

SELECT
OPEN_MONTH,
AVG(OPEN_TIME) AS AVG_OPEN_TIME
FROM RAW
GROUP BY OPEN_MONTH
ORDER BY OPEN_MONTH
